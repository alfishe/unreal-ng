name: CMake CI

on:
  push:
    branches: [ "master" ]
    paths-ignore:
      - 'docs/**'
      - 'tools/**'
      - 'data/**'
      - 'testdata/**'
      - '.gitignore'
  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - 'docs/**'
      - 'tools/**'
      - 'data/**'
      - 'testdata/**'
      - '.gitignore'

env:
  BUILD_TYPE: Release
  # LD_LIBRARY_PATH is already set correctly inside the Docker image,
  # so we don't need to override it here.

jobs:
  build-linux:
    runs-on: ubuntu-latest # <--- The VM that runs Docker

    # 1. TELL GITHUB TO RUN INSIDE YOUR IMAGE
    container:             # <--- Custom environment inside the VM
      image: ghcr.io/alfishe/unreal-ng:qt6.9.3
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build project
        run: |
          # 2. FIX GIT PERMISSIONS
          # GitHub mounts the code as a volume; git inside the container 
          # requires this to trust the directory ownership.
          git config --global --add safe.directory $GITHUB_WORKSPACE

          # 3. BUILD
          # Based on your previous script, source is in 'unreal-qt' folder
          cd unreal-qt
          
          # Use Ninja (installed in your image) for faster builds
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          cmake --build build --parallel