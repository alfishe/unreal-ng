  # Analysis Data Model (SQLite-based)

To handle the massive and repetitive data generated by high-speed emulation, a structured SQLite schema is proposed for persistence and query-based analysis.

## Core Trace Schemas

### Execution Trace
Stores instruction-level events with CPU state snapshots.
```sql
CREATE TABLE execution_trace (
    id INTEGER PRIMARY KEY,
    frame_num INTEGER NOT NULL,
    t_state INTEGER NOT NULL,
    scanline INTEGER,
    pc INTEGER NOT NULL,
    mnemonic TEXT,  -- e.g., "LD A,#FF"
    reg_af, reg_bc, reg_de, reg_hl, reg_sp INTEGER, -- Registers
    is_call, is_return, is_jump BOOLEAN,
    target_address INTEGER
);
```

### Memory Access Log
High-frequency log for data flow analysis.
```sql
CREATE TABLE memory_access_log (
    id INTEGER PRIMARY KEY,
    frame_num INTEGER NOT NULL,
    address INTEGER NOT NULL,
    value INTEGER NOT NULL,
    access_type TEXT NOT NULL,  -- 'READ', 'WRITE', 'EXECUTE'
    source_pc INTEGER NOT NULL
) WITHOUT ROWID;
```

## Semantic Analysis Schemas

### Routine Behavioral Fingerprints
Stores the derived "essence" of a procedure.
```sql
CREATE TABLE routine_behaviors (
    routine_id INTEGER PRIMARY KEY,
    entry_pc INTEGER NOT NULL UNIQUE,
    primary_class TEXT,  -- 'music_player', 'effect', 'decompressor'
    is_periodic BOOLEAN,
    avg_cycles INTEGER,
    memory_regions TEXT,  -- JSON array of {start, end, access_type}
    io_ports TEXT         -- JSON array of port numbers
);
```

### Graphics & Screen Updates
Tracks visual changes and object discovery.
```sql
CREATE TABLE graphics_objects (
    id INTEGER PRIMARY KEY,
    address INTEGER NOT NULL,
    size_bytes INTEGER,
    width, height INTEGER,
    object_type TEXT,  -- 'sprite', 'charset', 'tile'
    image_data BLOB    -- PNG or raw pixel data
);
```

## Data Collection Strategies
- **Passive Mode**: Only update code coverage counters and memory heatmaps.
- **Active Mode**: Use circular buffers to log detailed trace data to SQLite.
- **Context-Aware Logging**: Only log full execution for "once-off" routines like decompressors, while using summaries for "periodic" routines like music players.
