# TR-DOS FORMAT Track Structure (6250 bytes)

This document describes the exact byte sequence written by TR-DOS during the FORMAT command via the WD1793's WRITE TRACK operation.

## Overview

TR-DOS formats disks using a standard IBM System 34 MFM format variant:
- **16 sectors per track** with 256 bytes per sector
- **1:2 interleave** pattern for optimal sequential read performance
- Total track size: **6250 bytes** (at 250kbps, 200ms revolution)

## Key Memory Addresses (TR-DOS 5.04T)

| Address | Variable | Description |
|---------|----------|-------------|
| `$5CE6` | Format table ptr | Points to sector interleave table for formatting |
| `$5CE8` | Verify table ptr | Points to sector table for verification |
| `$5CD7` | Track count | Number of tracks to format (40 or 80) |
| `$5CDA` | Side count | `$80` for double-sided, other for single |
| `$1FB9` | Normal interleave | ROM table: 1,9,2,10,3,11,4,12,5,13,6,14,7,15,8,16 |
| `$325A` | Turbo interleave | ROM table: 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16 |

## Sector Interleave Pattern

**Normal Format** (1:2 interleave at `$1FB9`):
```
1, 9, 2, 10, 3, 11, 4, 12, 5, 13, 6, 14, 7, 15, 8, 16
```

**Turbo Format** (1:1 sequential at `$325A`):
```
1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16
```

## Track Layout (6250 bytes total)

The track consists of 16 sectors repeated, each with the following structure, followed by a gap to fill the remaining space.

### Single Sector Structure (388 bytes)

```
┌─────────────────────────────────────────────────────────────────┐
│ SECTOR START GAP (22 bytes)                                     │
├─────────────────────────────────────────────────────────────────┤
│ gap0[10]   = 4E 4E 4E 4E 4E 4E 4E 4E 4E 4E                      │
│ sync0[12]  = 00 00 00 00 00 00 00 00 00 00 00 00                │
├─────────────────────────────────────────────────────────────────┤
│ ID ADDRESS MARK BLOCK (10 bytes)                                │
├─────────────────────────────────────────────────────────────────┤
│ sync[3]    = A1 A1 A1  (written as F5 F5 F5 - missing clock)    │
│ IDAM       = FE        (ID Address Mark)                        │
│ Cylinder   = CC        (Track number: 0-79)                     │
│ Head       = 00        (Always 0 in TR-DOS)                     │
│ Sector     = SS        (Sector number: 1-16)                    │
│ Size       = 01        (256 bytes per sector)                   │
│ CRC[2]     = XX XX     (generated by F7 command)                │
├─────────────────────────────────────────────────────────────────┤
│ GAP BETWEEN IDAM AND DATA (34 bytes)                            │
├─────────────────────────────────────────────────────────────────┤
│ gap1[22]   = 4E 4E 4E ... (22 × 0x4E)                           │
│ sync1[12]  = 00 00 00 00 00 00 00 00 00 00 00 00                │
├─────────────────────────────────────────────────────────────────┤
│ DATA ADDRESS MARK BLOCK (262 bytes)                             │
├─────────────────────────────────────────────────────────────────┤
│ sync[3]    = A1 A1 A1  (written as F5 F5 F5 - missing clock)    │
│ DAM        = FB        (Data Address Mark, or F8 for deleted)   │
│ data[256]  = 00 00 ... (256 × 0x00 - empty sector data)         │
│ CRC[2]     = XX XX     (generated by F7 command)                │
├─────────────────────────────────────────────────────────────────┤
│ SECTOR END GAP (60 bytes)                                       │
├─────────────────────────────────────────────────────────────────┤
│ gap2[60]   = 4E 4E 4E ... (60 × 0x4E)                           │
└─────────────────────────────────────────────────────────────────┘

Total per sector: 10 + 12 + 3 + 7 + 22 + 12 + 3 + 1 + 256 + 2 + 60 = 388 bytes
```

### Complete Track Layout

```
16 sectors × 388 bytes = 6208 bytes
End gap = 42 bytes (0x4E fill)
────────────────────────────
Total = 6250 bytes
```

## WD1793 Special Byte Translations

During WRITE TRACK, the WD1793 translates special control bytes:

| Written | Becomes | Description |
|---------|---------|-------------|
| `F5`    | `A1`    | Sync byte with missing clock (presets CRC to $CDB4) |
| `F6`    | `C2`    | Index mark with missing clock |
| `F7`    | 2 bytes | Generates and writes CRC (2 bytes) |
| `FE`    | `FE`    | ID Address Mark (literal) |
| `FB`    | `FB`    | Data Address Mark (literal) |
| `F8`    | `F8`    | Deleted Data Address Mark (literal) |
| Other   | Same    | Written literally |

## CRC Calculation

The WD1793 uses CRC-CCITT polynomial `0x1021` with preset value `0xCDB4` (preset after 3× A1 sync bytes):

```cpp
uint16_t calculateCRC(const uint8_t* data, size_t length) {
    uint16_t crc = 0xCDB4;  // Preset after A1 A1 A1
    for (size_t i = 0; i < length; i++) {
        crc ^= static_cast<uint16_t>(data[i]) << 8;
        for (int j = 0; j < 8; j++) {
            crc = (crc << 1) ^ ((crc & 0x8000) ? 0x1021 : 0);
        }
    }
    return crc;
}
```

**IDAM CRC** covers: `FE CC HH SS NN` (5 bytes)
**Data CRC** covers: `FB + 256 data bytes` (257 bytes)

## Automation Bypass Pattern

When automating FORMAT without user interaction, the breakpoint at `$1EDD` must be bypassed correctly:

```cpp
// At $1EDD breakpoint (before CALL $3200):
// 1. Set sector table pointer for normal format
memory->DirectWriteToZ80Memory(0x5CE6, 0xB9);  // Low byte of $1FB9
memory->DirectWriteToZ80Memory(0x5CE7, 0x1F);  // High byte of $1FB9

// 2. Set verify table pointer  
memory->DirectWriteToZ80Memory(0x5CE8, 0xBA);  // Low byte of $1FBA
memory->DirectWriteToZ80Memory(0x5CE9, 0x1F);  // High byte of $1FBA

// 3. Set drive type for 80-track
cpu->a = 0x80;

// 4. Skip the CALL instruction (jump past it)
cpu->pc = 0x1EE0;
```

> **⚠️ Hazard #185: Sector Table Pointer Initialization**
> Bypassing `CALL $3200` without initializing `$5CE6` and `$5CE8` causes garbage sector numbers because the interleave table pointer is uninitialized.

## References

- TR-DOS 5.04T ROM Disassembly (`docs/rom/trdos504t.asm.txt`)
- WD1793 Datasheet
- IBM System 34 MFM Format Specification
